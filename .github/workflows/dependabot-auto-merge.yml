name: Dependabot auto-merge

# Trigger on pull request events (opened, synchronized, reopened)
# This allows auto-merge to be re-evaluated when PRs are updated
on: 
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Comment on patch and minor updates
        # For patch and minor version updates, add a comment to guide manual review and merge
        # This avoids unsafe auto-merging when no CI checks are configured on pull requests
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr comment "$PR_URL" --body "‚úÖ **Dependabot patch/minor update detected**

          This PR updates dependencies with a patch or minor version change.

          Please ensure that all relevant CI checks (if configured) have passed and that the
          application still builds and runs as expected before merging this PR manually."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on major version updates
        # Add a comment on major version updates to remind about manual review
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "üîç **Major version update detected**

          This PR contains a major version update which may include breaking changes.
          Please review the changelog and test thoroughly before merging.

          To merge this PR, manually review and approve it."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Label Dependabot PRs
        # Add helpful labels based on update type
        # Only runs when UPDATE_TYPE matches one of the expected semver types
        # Continue on error if labels don't exist in the repository
        continue-on-error: true
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-major' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor' ||
          steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: |
          if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            gh pr edit "$PR_URL" --add-label "major-update"
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
            gh pr edit "$PR_URL" --add-label "minor-update"
          else
            gh pr edit "$PR_URL" --add-label "patch-update"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPDATE_TYPE: ${{ steps.metadata.outputs.update-type }}
